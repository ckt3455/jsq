<?phpnamespace backend\models;use Yii;use yii\helpers\Url;/** * This is the model class for table "{{%cart}}". * * @property integer $id * @property integer $goods_id * @property integer $sku_id * @property integer $number * @property integer $user_id * @property integer $append * @property integer $updated */class Cart extends \yii\db\ActiveRecord{    /**     * @inheritdoc     */    public static function tableName()    {        return '{{%cart}}';    }    /**     * @inheritdoc     */    public function rules()    {        return [            [['goods_id', 'sku_id', 'number', 'user_id'], 'required'],            [['goods_id', 'sku_id', 'number', 'user_id', 'append', 'updated'], 'integer'],        ];    }    /**     * @inheritdoc     */    public function attributeLabels()    {        return [            'id' => 'ID',            'goods_id' => '产品',            'sku_id' => 'Sku',            'number' => '数量',            'user_id' => '用户',            'append' => '添加时间',            'updated' => '更新时间',        ];    }    /**     * @param bool $insert     * @return bool     * 自动插入     */    public function beforeSave($insert)    {        if($this->isNewRecord)        {            $this->append = time();        }        else        {            $this->updated = time();        }        return parent::beforeSave($insert);    }    /**     * 购物车数量     */    public static function getCount(){        $user_id=Yii::$app->user->id;        if($user_id){            $count=Cart::find()->where(['user_id'=>$user_id,'type'=>1])->joinWith('goods',false,'RIGHT JOIN')->groupBy('goods_id')->count();        }        else{            $count=0;        }        return $count;    }    /**     * 关联产品     */    public function getGoods(){        return $this->hasOne(Goods::className(), ['id' => 'goods_id']);    }    /**     * 关联sku     */    public function getSku(){        return $this->hasOne(Sku::className(), ['id' => 'sku_id']);    }    /**     * 购物车中同一个产品下的sku     */    public function getChildren(){        return $this->hasMany(Cart::className(), ['goods_id' => 'goods_id'])->where(['user_id'=>Yii::$app->user->id]);    }    /**     *添加到购物车     */        public static function add_cart($sku_id,$number,$type=1){        $sku=Sku::findOne($sku_id);        $model=Cart::find()->where(['user_id'=>Yii::$app->user->id,'sku_id'=>$sku_id,'type'=>$type])->one();        if(empty($model)){            $model=new Cart();            $model['sku_id']=$sku_id;            $model['user_id']=Yii::$app->user->id;            $model['number']=$number;            if(isset($sku->goods)){                $model['goods_id']=$sku->goods->id;            }else{                $model['goods_id']=0;            }            $model['type']=$type;        }        else{            $model->number+=$number;        }        if($model->save()){            return true;        }        else{            return false;        }    }    /**     *删除购物车中的数据     * $type=1 根据产品删除，$type=2,根据sku删除     */    public static function deleteCart($type,$id,$user_id){        if($type==1){            $models=Cart::find()->where(['goods_id'=>$id,'user_id'=>$user_id])->all();        }        if($type==2){            $models=Cart::find()->where(['sku_id'=>$id,'user_id'=>$user_id])->all();        }        if($models->delete()){            return true;        }        else{            return false;        }    }    public function getTitle(){        if($this->goods){            return '<a href="'.Url::to(['goods/detail','id'=>$this->goods_id]).'">'.Sku::sku_title($this->goods_id,$this->sku_id).'</a>';        }else{            return '';        }    }}