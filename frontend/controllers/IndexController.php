<?phpnamespace frontend\controllers;use backend\models\Code;use backend\models\Contact;use backend\models\Message;use backend\models\Goods;use backend\models\GoodsCategory;use backend\models\News;use backend\models\Order;use backend\models\SetCategory;use backend\models\SetImage;use backend\models\User;use backend\models\UserHistory;use backend\models\UserLevel;use backend\models\UserRelation;use backend\models\UserRelation2;use common\components\Helper;use Yii;use yii\base\BaseObject;use yii\db\Exception;/** * Index controller */class IndexController extends FController{    /**     * @return string     * 默认首页     */    public function actionTest()    {        $arr='{"credit":{"rule":{"type":"credit","use_credit":28,"member_total":50,"cut_price":28,"rate":"1"},"price":28,"use_credit":28}}';        $arr=json_decode($arr,true);        print_r($arr);exit;        foreach($arr as $k=>$v){            if(isset($v['other_xm'])){                $qt_message[]=[                    'other_xm'=>$v['other_xm'],                    'other_money'=>$v['other_money'],                    'other_bl'=>100,                    'other_money2'=>$v['other_money'],                    'other_content'=>$v['other_content'],                ];            }else{                throw new ApiException('数据不正确', 1);            }        }        print_r($pj_message);exit;    }    public function actionIndex()    {                $data = [];        $data['banner'] = SetImage::getList(['type' => 1]);        $data['goods']=Goods::find()->where(['type'=>1])->orderBy('sort asc,id desc')->all();        $data['goods2']=Goods::find()->where(['type'=>2])->orderBy('sort asc,id desc')->all();        $data['goods3']=Goods::find()->where(['type'=>3])->orderBy('sort asc,id desc')->all();        $number=0;        $level_id=0;        if(Yii::$app->session->get('user_id')){            $user=User::findOne(Yii::$app->session->get('user_id'));            if(!$user->name){                return $this->message('请填写一下昵称',$this->redirect(['user/info']));            }            $level_id=$user['level_id'];            $order=Order::find()->where(['user_id'=>Yii::$app->session->get('user_id')])->andWhere(['>=','status',2])->limit(1)->one();            if($order){                if($user['level_id']>0){                    $level=UserLevel::findOne($user['level_id']);                    if($level->number>0){                        $number=$level->number;                    }                }            }        }        $message=SetImage::getList(['type'=>3]);        return $this->render('index',            [                'data' => $data,                'message'=>$message,                'number'=>$number,                'level_id'=>$level_id,            ]        );    }    public function actionRegister()    {        if (Yii::$app->session->get('user_id')) {            return $this->goHome();        }        return $this->render('register');    }    public function actionPassword()    {        if (Yii::$app->session->get('user_id')) {            return $this->goHome();        }        return $this->render('password');    }    public function actionLogin()    {        if (Yii::$app->session->get('user_id')) {            return $this->goHome();        }        return $this->render('login');    }    public function actionSms()    {        $post = Yii::$app->request->post();        $data = [];        $data['error'] = 0;        $data['message'] = '';        $phone = $post['phone'];        $is_mobile=preg_match('/^1[3-9]\d{9}$/', $phone);        if(!$is_mobile){            $data['error'] = 1;            $data['message'] = '手机号码格式不正确';            return json_encode($data, JSON_UNESCAPED_UNICODE);        }        $model = Code::find()->where(['phone' => $phone])->one();        $number = rand(10000, 99999);        if ($model) {            if ((time() - $model['create_time']) <= 60) {                $data['error'] = 1;                $data['message'] = '短信发送太频繁，请等待1分钟';                return json_encode($data, JSON_UNESCAPED_UNICODE);            } else {                $model['number'] = $number;                $model['phone'] = "$phone";                $model['expire_time'] = time() + 300;                $model['create_time'] = time();            }        } else {            $model = new Code();            $model['number'] = $number;            $model['phone'] = "$phone";            $model['expire_time'] = time() + 300;            $model['create_time'] = time();        }        if ($model->save()) {            $re = Helper::sendSms2($phone, $number);            $re=json_decode($re,true);            if ($re['code']==200) {                $data['error'] = 0;            } else {                $data['error'] = 1;                $data['message'] = '发送失败';            }        } else {            $data['error'] = 1;            $data['message'] = '发送失败';        }        return json_encode($data, JSON_UNESCAPED_UNICODE);    }    public function actionSendSms(){        $data=[            'error'=>1,            'message'=>''        ];        if (Yii::$app->session->get('user_id')) {            $data['message']='发生错误';        }else{            $mobile=Yii::$app->request->post('mobile');            $user=User::find()->where(['mobile'=>$mobile])->limit(1)->one();            if($user){                $data['message']='该账号已注册';            }else{                $code=mt_rand(10000,99999);                $model=Code::find()->where(['phone'=>$mobile])->limit(1)->one();            }            $re=Helper::sendSms2('13957857314','123456');        }    }    public function actionLogout()    {                Yii::$app->session->remove('user_id');        return $this->redirect(['index/login']);    }    public function actionRegister2()    {        $data = [            'error' => 1,            'message' => ''        ];        if (Yii::$app->request->post()) {            $post = Yii::$app->request->post();            $mobile = $post['mobile'];            $sms = $post['sms'];            $password = $post['password'];            $re_password = $post['re_password'];            $code = $post['code'];            $name=$post['name'];            if (!$mobile) {                $data['message'] = '请填写手机号码';                return json_encode($data);            }            if (!$sms) {                $data['message'] = '请填写验证码';                return json_encode($data);            }            if (!$password) {                $data['message'] = '请填写密码';                return json_encode($data);            }            if (!$code) {                $data['message'] = '请填写邀请码';                return json_encode($data);            }            if ($password != $re_password) {                $data['message'] = '两次输入的密码不一致';                return json_encode($data);            }            if(!$name){                $data['message'] = '请填写名称';                return json_encode($data);            }            $re = Helper::checkSMS($mobile, $sms);            if ($re['error'] == 0) {                $parent = User::find()->where(['code' => $code])->limit(1)->one();                if (!$parent) {                    $data['message'] = '邀请码不正确';                } else {                    $new = new User();                    $new->mobile = $mobile;                    $new->parent_id = $parent->id;                    $new->password = $password;                    $new->name=$name;                    if (!$new->save()) {                        $errors = $new->getFirstErrors();                        $data['message'] = reset($errors);                    } else {                        $data['error'] = 0;                    }                }            } else {                $data['message'] = $re['message'];            }        }        return json_encode($data);    }    public function actionLogin2()    {        $data = [            'error' => 1,            'message' => ''        ];        if (Yii::$app->request->post()) {            $post = Yii::$app->request->post();            $mobile = $post['mobile'];            $password = $post['password'];            if (!$mobile) {                $data['message'] = '请填写手机号码';                return json_encode($data);            }            if (!$password) {                $data['message'] = '请填写密码';                return json_encode($data);            }            $model = User::find()->where(['mobile' => $mobile])->limit(1)->one();            if (!$model) {                $data['message'] = '用户不存在';                return json_encode($data);            }            if (md5(md5($password) . 'ysdf') != $model->password) {                $data['message'] = '密码不正确';                return json_encode($data);            }            Yii::$app->session->set('user_id', $model->id);            $data['error'] = 0;        }        return json_encode($data);    }    public function actionPassword2()    {        $data = [            'error' => 1,            'message' => ''        ];        if (Yii::$app->request->post()) {            $post = Yii::$app->request->post();            $mobile = $post['mobile'];            $sms = $post['sms'];            $password = $post['password'];            $re_password = $post['re_password'];            if (!$mobile) {                $data['message'] = '请填写手机号码';                return json_encode($data);            }            if (!$sms) {                $data['message'] = '请填写验证码';                return json_encode($data);            }            if (!$password) {                $data['message'] = '请填写密码';                return json_encode($data);            }            if ($password != $re_password) {                $data['message'] = '两次输入的密码不一致';            }            $re = Helper::checkSMS($mobile, $sms);            if ($re['error'] == 0) {                    $old=User::find()->where(['mobile'=>$mobile])->limit(1)->one();                    if(!$old){                        $data['message'] = '该手机未注册';                    }else{                        $old->password = $password;                        if (!$old->save()) {                            $errors = $old->getFirstErrors();                            $data['message'] = reset($errors);                        } else {                            $data['error'] = 0;                        }                    }            } else {                $data['message'] = $re['message'];            }        }        return json_encode($data);    }    public function actionMessage(){        $message=SetImage::getOne(['type'=>4]);        return $this->render('message', ['model'=>$message]);    }}